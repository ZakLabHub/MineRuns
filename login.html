<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Signup - ZakLab</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@700&display=swap">
<style>
@font-face {
  font-family: 'SKCuber';
  src: url('fonts/SKCuber-Expanded.ttf') format('truetype');
}
body {
  margin:0; font-family:'League Spartan', sans-serif; background:#121212;
  display:flex; justify-content:center; align-items:center; height:100vh; color:#fff;
}
.container {
  background: rgba(100,0,255,0.2); padding:40px; border-radius:15px; text-align:center; width:320px;
}
.logo {
  font-family: 'SKCuber', sans-serif; font-size:48px; color:violet; text-align:left; margin-bottom:20px;
}
input {
  width:100%; padding:10px; margin:10px 0; border-radius:10px; border:none;
  background: rgba(255,255,255,0.1); color:#fff; font-size:16px; font-weight:bold;
}
button {
  width:100%; padding:12px; background:violet; border:none; border-radius:10px;
  color:#fff; font-weight:bold; margin-top:10px;
}
#doneBtn {
  cursor:not-allowed;
  opacity:0.6;
}
#doneBtn.enabled { cursor:pointer; opacity:1; }
.checkbox { margin:15px 0; font-size:14px; text-align:left; }
a { color:#fff; text-decoration:underline; cursor:pointer; }
#codeSection { display:none; margin-top:10px; }
#timer { margin-top:5px; font-size:14px; color:#ddd; }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabaseUrl = 'https://cesmjxusnkaymfuubwgl.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNlc21qeHVzbmtheW1mdXVid2dsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3NzA4MDIsImV4cCI6MjA3MTM0NjgwMn0.Ksyn8lOlIsrhpmb7n4Pd7SJmv1qPaPe3vipqPaCe1Bc';
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

let verificationCode = '';
let codeExpiry = 0;
let timerInterval;
const functionUrl = "https://cesmjxusnkaymfuubwgl.supabase.co/functions/v1/resend-email";

async function sendVerificationCode() {
    const email = document.getElementById('email').value;
    if(!email) return alert("Enter your email first");

    // Générer code aléatoire 4 chiffres
    verificationCode = Math.floor(1000 + Math.random() * 9000).toString();
    codeExpiry = 5*60;

    // Afficher le champ code et timer
    document.getElementById('codeSection').style.display = 'block';
    document.getElementById('timer').textContent = '05:00';

    clearInterval(timerInterval);
    timerInterval = setInterval(()=>{
        let min = Math.floor(codeExpiry/60);
        let sec = codeExpiry%60;
        document.getElementById('timer').textContent = `${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
        codeExpiry--;
        if(codeExpiry<0){ clearInterval(timerInterval); alert("Verification code expired"); }
        checkForm();
    },1000);

    // Envoi réel via Supabase Function
    try {
        const res = await fetch(functionUrl, {
            method:'POST',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({ email, code: verificationCode })
        });
        const data = await res.json();
        if(data.status === "ok"){
            alert("Verification code sent! Check your email.");
        } else {
            alert("Error sending verification code");
        }
    } catch(e){
        alert("Error connecting to email service");
        console.error(e);
    }
}

function checkForm() {
    const email = document.getElementById('email').value;
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const code = document.getElementById('codeInput') ? document.getElementById('codeInput').value : '';
    const cgu = document.getElementById('cgu').checked;
    const btn = document.getElementById('doneBtn');

    if(email && username && password && code===verificationCode && codeExpiry>0 && cgu){
        btn.classList.add('enabled');
        btn.disabled = false;
    } else {
        btn.classList.remove('enabled');
        btn.disabled = true;
    }
}

async function signUpUser(event){
    event.preventDefault();
    const email = document.getElementById('email').value;
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;

    // Vérifier si username existe déjà
    const { data: existing } = await supabase.from('users').select('username').eq('username', username);
    if(existing.length>0){ alert("Username already taken"); return; }

    // Signup via Supabase Auth
    const { data, error } = await supabase.auth.signUp({ email, password });
    if(error){ alert(error.message); return; }

    // Ajouter username et consentement CGU dans table users
    await supabase.from('users').insert([{ id:data.user.id, email, username, accepted_cgu:true }]);

    alert("Signup successful! Check your email to confirm.");
    window.location.href = "home.html";
}

// Vérifier session pour redirection si déjà connecté
supabase.auth.getSession().then(({data:{session}})=>{
    if(session) window.location.href="home.html";
});
</script>
</head>
<body>
<div class="container">
    <div class="logo">-M-</div>
    <form oninput="checkForm()" onsubmit="signUpUser(event)">
        <input type="email" id="email" placeholder="Email" required>
        <input type="text" id="username" placeholder="Username" required>
        <input type="password" id="password" placeholder="Password" required>
        <button type="button" id="sendCodeBtn" onclick="sendVerificationCode()">Send Verification Code</button>
        <div id="codeSection">
            <input type="text" id="codeInput" placeholder="Enter verification code" required>
            <div id="timer">05:00</div>
        </div>
        <div class="checkbox">
            <input type="checkbox" id="cgu"> If you click here, you agree that we collect data to operate the site
        </div>
        <button id="doneBtn" type="submit" disabled>Done</button>
    </form>
    <div style="margin-top:15px;">
        You already have an account? <a href="connection.html">click here</a>
    </div>
</div>
</body>
</html>
